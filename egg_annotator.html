<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Egg Hunt Annotator</title>
    <style>
        body{background: #f2f6f8;}
        
        #annotation_box {z-index:10;}

        #garden{position:absolute;z-index:1;}

        #container{
            display:inline-block;
            margin: 0 auto; 
            background: blue; 
            position:relative; 
            border:5px solid green; 
            width:3200px; 
            height:4800px;
            border-radius: 10px; 
            box-shadow: 0 5px 50px #333}

        #overlay_canvas{
            position:relative;
            z-index:20;
            width:3200px; 
            height:4800px;
            pointer-events: none;
        }
    </style>
</head>

<body onload="run_annotator()">
   
    <div id="container">    
        <img id="garden" src="The_Garden_of_Earthly_Delights_by_Bosch_High_Resolution_2.jpg" />
        <canvas id="overlay_canvas"></canvas>

    </div>
    
    <div id="annotation_box" style="cats: meow; position: absolute; background-color: beige; left: 100; top: 100">
        <p>Name: <textarea id="name_area"></textarea></p>
        <p>Notes: <textarea id="note_area"></textarea></p>
        <p><button id="submit_egg">Submit</button><button id="cancel_egg">Cancel</button></p>
    </div>
<script>
        const initial_eggs = [{"x":1028,"y":2287,"radius":11.40175425099138,"name":"brown egg","notes":"Small, shiny, brown. Other possible eggs nearby."},{"x":3950,"y":2084,"radius":30,"name":"egg hat","notes":"large white egg shaped... hat? In the parade."},{"x":4518,"y":2365,"radius":14.317821063276353,"name":"boar testicles","notes":"could be an egg. Bluish."},{"x":5280,"y":692,"radius":45.27692569068709,"name":"pink building egg","notes":"dubious as an egg; has spines."},{"x":5167,"y":3188,"radius":100.40916292848975,"name":"pink marble egg.","notes":"distinctly egg-shaped."},{"x":3222,"y":4075,"radius":77.69813382572325,"name":"spherical pink egg with blue veins","notes":"A guy is leaning on it; not an archetypal egg."},{"x":5285,"y":3946,"radius":19.924858845171276,"name":"purple vine egg","notes":"probably a fruit, but whatever"},{"x":5518,"y":2921,"radius":57.87054518492115,"name":"hidden owl egg.","notes":"not visible, but the owl looks like it's hiding something."},{"x":5246,"y":1346,"radius":27.80287754891569,"name":"heron egg","notes":"just herons, but there's probably an egg in there."},{"x":4449,"y":477,"radius":67.47592163134935,"name":"oblong marble egg house","notes":"on top of a building, made of marble, with a person and a tree inside."},{"x":369,"y":2017,"radius":19.849433241279208,"name":"duck egg","notes":"looks like the duck could be sitting on a nest."},{"x":1512,"y":3390,"radius":27.459060435491963,"name":"bunny egg 1","notes":"clearly this rabbit is laying an egg."},{"x":1720,"y":3442,"radius":26.92582403567252,"name":"bunny egg 2","notes":"this rabbit is also laying an egg."},{"x":6584,"y":2350,"radius":25.495097567963924,"name":"back balance egg","notes":"balancing an egg on their back."},{"x":6798,"y":1472,"radius":43.139309220245984,"name":"nun","notes":"shaped a little like an egg"},{"x":7419,"y":3554,"radius":7.615773105863909,"name":"poo egg","notes":"egg colored; I guess he has a cloaca?"},{"x":7416,"y":3503,"radius":6.4031242374328485,"name":"poo egg 2","notes":"also from the cloaca"}]
        
        let current_egg = {start_x: 0,start_y: 0,end_x: 0,end_y: 0,radius:0};
        let all_eggs = initial_eggs;

        function redraw() {
            let canvas = document.getElementById('overlay_canvas');
            let context = canvas.getContext('2d');
            context.clearRect(0, 0, canvas.width, canvas.height);
            draw_all_eggs();
        }

        function draw_circle(x,y,r,color) {
            console.log("drawing circle; x="+x+" y=" + y + " r="+r);
            let canvas = document.getElementById('overlay_canvas');
            let context = canvas.getContext('2d');
            context.beginPath();
            context.arc(x, y, r, 0, 2 * Math.PI);
            context.lineWidth = 2;
            context.strokeStyle = color;
            context.stroke();
        }

        function draw_all_eggs() {
            all_eggs.forEach(egg => draw_circle(egg.x,egg.y,egg.radius,'blue'))
        }

        function egg_marked(e) {
            console.log("clicked garden; e.x="+e.x+", e.offsetX="+e.offsetX);
            let ab = document.getElementById('annotation_box');
            
            ab.style.display="inline";
            ab.style.position = "absolute";
            ab.style.left = (e.offsetX+15)+'px';
            ab.style.top = (e.offsetY+15)+'px';

            //egg_end = {x:e.offsetX,y:e.offsetY};
            current_egg.end_x = e.offsetX;
            current_egg.end_y = e.offsetY;
            let dx = current_egg.start_x-current_egg.end_x;
            let dy = current_egg.start_y-current_egg.end_y;
            current_egg.radius = Math.sqrt(dx*dx+dy*dy);
            console.log("marked an egg with radius "+current_egg.radius);
            redraw();
            draw_circle(current_egg.start_x,current_egg.start_y,current_egg.radius,'red');

        }

        function cancel_ab() {
            console.log("clicked cancel");
            let ab = document.getElementById('annotation_box');
            ab.style.display="none";
        }

        function submit_ab() {
            let egg_name_area = document.getElementById('name_area');
            let egg_note_area = document.getElementById('note_area');

            let egg_name = egg_name_area.value;
            let egg_notes = egg_note_area.value;
            console.log("clicked submit; name was " + egg_name);
            let ab = document.getElementById('annotation_box');
            ab.style.display="none";
            let egg_addition = {x: current_egg.start_x, y: current_egg.start_y, radius: current_egg.radius, name: egg_name, notes: egg_notes};
            all_eggs.push(egg_addition);
            console.log(JSON.stringify(all_eggs));
            egg_name_area.value = "";
            egg_note_area.value = "";
        }

        function run_annotator() {
            console.log("called run_annotator");
            let garden = document.getElementById("garden");
            let gcontainer = document.getElementById("container");
            let canvas = document.getElementById('overlay_canvas');

            gcontainer.style.width = garden.clientWidth+"px";
            gcontainer.style.height = garden.clientHeight+"px";
            canvas.style.width = garden.clientWidth+"px";
            canvas.style.height = garden.clientHeight+"px";
            canvas.width = garden.clientWidth;
            canvas.height = garden.clientHeight;

            console.log("Garden width: " + garden.clientWidth);
            console.log("container width: " + gcontainer.style.width);

            let ab = document.getElementById('annotation_box');
            let cancel_button = document.getElementById('cancel_egg');
            let submit_button = document.getElementById('submit_egg');

            garden.onmousedown = function(e) {current_egg.start_x = e.offsetX; current_egg.start_y = e.offsetY};
            //canvas.onmousedown = function(e) {egg_start.x = e.offsetX; egg_start.y = e.offsetY};
            garden.onmouseup = egg_marked;
            //canvas.onmouseup = egg_marked();
            garden.ondragstart = function() {return false};
            cancel_button.onclick = cancel_ab; 
            submit_button.onclick = submit_ab;
            redraw();
        }

    </script>

</body>

</html>